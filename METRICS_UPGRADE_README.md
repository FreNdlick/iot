# Модернизация системы метрик

## Обзор изменений

Система метрик была значительно модернизирована для улучшения точности вычислений и добавления новых математических возможностей.

## Основные улучшения

### 1. Увеличение размера окна
- **Было**: 100 значений
- **Стало**: 3000 значений (настраивается через конфигурацию)
- **Преимущества**: Более точные статистические вычисления, лучшая спектральная разрешающая способность

### 2. Новый класс FFTProcessor
- Специализированный класс для БПФ и спектрального анализа
- Поддержка окон до 3000 значений
- Оптимизированные алгоритмы для поиска доминирующих частот
- Вычисление спектральной плотности мощности методом Уэлча

### 3. Новые математические метрики

#### Спектральные метрики:
- **Спектральная энергия** - общая энергия сигнала в частотной области
- **Спектральный центроид** - "центр тяжести" спектра
- **Спектральная ширина полосы** - мера разброса частот
- **Доминирующие частоты** - основные частотные компоненты сигнала

#### Статистические метрики:
- **Асимметрия (skewness)** - мера асимметрии распределения
- **Эксцесс (kurtosis)** - мера "остроты" распределения

#### Метрики обнаружения аномалий:
- **Счет аномалий** - интегрированная оценка аномальности на основе спектральных характеристик

### 4. Оптимизация памяти
- Использование циклических буферов (deque) для экономии памяти
- Настраиваемое кэширование БПФ вычислений
- Конфигурируемые ограничения на использование памяти

### 5. Система конфигурации
- Централизованная конфигурация в `config.py`
- Настройка через переменные окружения
- Валидация параметров конфигурации

## Новые Prometheus метрики

### Температура:
- `mqtt_{sensor}_temp_spectral_energy` - спектральная энергия
- `mqtt_{sensor}_temp_spectral_centroid` - спектральный центроид
- `mqtt_{sensor}_temp_spectral_bandwidth` - спектральная ширина полосы
- `mqtt_{sensor}_temp_dominant_freq` - доминирующая частота
- `mqtt_{sensor}_temp_skewness` - асимметрия
- `mqtt_{sensor}_temp_kurtosis` - эксцесс

### Влажность:
- `mqtt_{sensor}_humidity_spectral_energy` - спектральная энергия
- `mqtt_{sensor}_humidity_spectral_centroid` - спектральный центроид

### PM2.5:
- `mqtt_{sensor}_pm25_spectral_energy` - спектральная энергия
- `mqtt_{sensor}_pm25_spectral_centroid` - спектральный центроид

### Общие:
- `mqtt_{sensor}_anomaly_score` - счет аномалий

## Конфигурация

### Переменные окружения:

```bash
# Размеры окон
METRICS_WINDOW_SIZE=3000
METRICS_TREND_WINDOW_SIZE=3000
METRICS_FFT_WINDOW_SIZE=3000

# Минимальные размеры для вычислений
MIN_DATA_FOR_STDDEV=10
MIN_DATA_FOR_QUANTILES=15
MIN_DATA_FOR_TREND=100
MIN_DATA_FOR_FFT=100
MIN_DATA_FOR_CORRELATION=100

# Настройки БПФ
FFT_SAMPLE_RATE=1.0
FFT_NPERSEG=256
FFT_NOVERLAP=128

# Настройки обнаружения аномалий
ANOMALY_ALPHA=0.1
ANOMALY_MAX_SCORE=10.0
ANOMALY_PEAK_HEIGHT_RATIO=0.1
ANOMALY_PEAK_DISTANCE=5

# Оптимизация памяти
MAX_CACHED_FFT=10
ENABLE_FFT_CACHING=true

# Логирование
METRICS_LOG_LEVEL=INFO
LOG_SPECTRAL_METRICS=false
```

## Использование

### Базовое использование:
```python
from Analyz.metrics_process import metrics_processor, create_sensor_metrics

# Создание метрик для сенсора
sensor_metrics = create_sensor_metrics("sensor_001")

# Обработка новых данных
new_data = {
    'TemperatureC': 25.5,
    'Humidity': 60.0,
    'PM25': 15.0
}

metrics_processor.process_metrics("sensor_001", sensor_metrics, new_data)
```

### Настройка конфигурации:
```python
from config import config

# Изменение размера окна
config.WINDOW_SIZE = 5000

# Настройка обнаружения аномалий
config.ANOMALY_ALPHA = 0.05
config.ANOMALY_MAX_SCORE = 15.0
```

## Производительность

### Память:
- Циклические буферы ограничивают использование памяти
- Настраиваемое кэширование БПФ
- Автоматическая очистка старых данных

### Вычисления:
- БПФ вычисления выполняются только при достаточном количестве данных
- Оптимизированные алгоритмы поиска пиков
- Параллельная обработка различных типов данных

## Мониторинг в Grafana

Новые метрики можно использовать в Grafana для:
- Анализа спектральных характеристик сигналов
- Обнаружения аномалий в реальном времени
- Мониторинга качества данных
- Анализа трендов и паттернов

### Примеры запросов PromQL:
```promql
# Спектральная энергия температуры
mqtt_sensor001_temp_spectral_energy

# Счет аномалий
mqtt_sensor001_anomaly_score

# Доминирующая частота
mqtt_sensor001_temp_dominant_freq
```

## Совместимость

- Полная обратная совместимость с существующими метриками
- Все старые метрики продолжают работать
- Новые метрики добавляются автоматически

## Требования

- Python 3.7+
- NumPy
- SciPy
- Pandas
- Prometheus Client

## Устранение неполадок

### Высокое использование памяти:
- Уменьшите `WINDOW_SIZE` в конфигурации
- Отключите кэширование БПФ: `ENABLE_FFT_CACHING=false`

### Медленные вычисления:
- Увеличьте `MIN_DATA_FOR_FFT` для менее частых БПФ вычислений
- Уменьшите `FFT_NPERSEG` для более быстрых вычислений

### Неточные метрики:
- Увеличьте размеры окон в конфигурации
- Проверьте качество входных данных
